import{_ as s,o as n,c as a,d as l}from"./app.5809c03f.js";const d=JSON.parse('{"title":"\u524D\u7AEF\u90E8\u7F72\u65B9\u6848","description":"","frontmatter":{},"headers":[{"level":2,"title":"\u4E00. \u89E6\u53D1\u65B9\u5F0F","slug":"\u4E00-\u89E6\u53D1\u65B9\u5F0F","link":"#\u4E00-\u89E6\u53D1\u65B9\u5F0F","children":[{"level":3,"title":"1.1 \u81EA\u52A8\u89E6\u53D1","slug":"_1-1-\u81EA\u52A8\u89E6\u53D1","link":"#_1-1-\u81EA\u52A8\u89E6\u53D1","children":[]},{"level":3,"title":"1.2 \u624B\u52A8\u89E6\u53D1","slug":"_1-2-\u624B\u52A8\u89E6\u53D1","link":"#_1-2-\u624B\u52A8\u89E6\u53D1","children":[]}]},{"level":2,"title":"\u4E8C. \u90E8\u7F72\u65B9\u5F0F","slug":"\u4E8C-\u90E8\u7F72\u65B9\u5F0F","link":"#\u4E8C-\u90E8\u7F72\u65B9\u5F0F","children":[{"level":3,"title":"2.1 \u4F7F\u7528Docker\u90E8\u7F72","slug":"_2-1-\u4F7F\u7528docker\u90E8\u7F72","link":"#_2-1-\u4F7F\u7528docker\u90E8\u7F72","children":[]},{"level":3,"title":"2.2 \u666E\u901A\u90E8\u7F72","slug":"_2-2-\u666E\u901A\u90E8\u7F72","link":"#_2-2-\u666E\u901A\u90E8\u7F72","children":[]}]},{"level":2,"title":"\u4E09. \u8865\u5145","slug":"\u4E09-\u8865\u5145","link":"#\u4E09-\u8865\u5145","children":[{"level":3,"title":"3.1 Gitlab runner","slug":"_3-1-gitlab-runner","link":"#_3-1-gitlab-runner","children":[]},{"level":3,"title":"3.2 \u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548Cwatchtower\u8FD0\u884C\u7684\u547D\u4EE4","slug":"_3-2-\u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548Cwatchtower\u8FD0\u884C\u7684\u547D\u4EE4","link":"#_3-2-\u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548Cwatchtower\u8FD0\u884C\u7684\u547D\u4EE4","children":[]},{"level":3,"title":"3.3 Docker\u90E8\u7F72","slug":"_3-3-docker\u90E8\u7F72","link":"#_3-3-docker\u90E8\u7F72","children":[]}]},{"level":2,"title":"\u56DB. \u63A8\u8350\u65B9\u6848","slug":"\u56DB-\u63A8\u8350\u65B9\u6848","link":"#\u56DB-\u63A8\u8350\u65B9\u6848","children":[{"level":3,"title":"4.1 \u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93","slug":"_4-1-\u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93","link":"#_4-1-\u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93","children":[]},{"level":3,"title":"4.2 \u914D\u7F6EGitlab runner","slug":"_4-2-\u914D\u7F6Egitlab-runner","link":"#_4-2-\u914D\u7F6Egitlab-runner","children":[]},{"level":3,"title":"4.3 \u521B\u5EFA.gitlab-ci.yml\u6587\u4EF6","slug":"_4-3-\u521B\u5EFA-gitlab-ci-yml\u6587\u4EF6","link":"#_4-3-\u521B\u5EFA-gitlab-ci-yml\u6587\u4EF6","children":[]}]},{"level":2,"title":"\u4E94. \u6269\u5C55 - \u4F7F\u7528Github action","slug":"\u4E94-\u6269\u5C55-\u4F7F\u7528github-action","link":"#\u4E94-\u6269\u5C55-\u4F7F\u7528github-action","children":[]}],"relativePath":"devops/frontend/\u524D\u7AEF\u9879\u76EE\u90E8\u7F72\u65B9\u6848.md","lastUpdated":1677565224000}'),e={name:"devops/frontend/\u524D\u7AEF\u9879\u76EE\u90E8\u7F72\u65B9\u6848.md"},p=l(`<h1 id="\u524D\u7AEF\u90E8\u7F72\u65B9\u6848" tabindex="-1">\u524D\u7AEF\u90E8\u7F72\u65B9\u6848 <a class="header-anchor" href="#\u524D\u7AEF\u90E8\u7F72\u65B9\u6848" aria-hidden="true">#</a></h1><h2 id="\u4E00-\u89E6\u53D1\u65B9\u5F0F" tabindex="-1">\u4E00. \u89E6\u53D1\u65B9\u5F0F <a class="header-anchor" href="#\u4E00-\u89E6\u53D1\u65B9\u5F0F" aria-hidden="true">#</a></h2><h3 id="_1-1-\u81EA\u52A8\u89E6\u53D1" tabindex="-1">1.1 \u81EA\u52A8\u89E6\u53D1 <a class="header-anchor" href="#_1-1-\u81EA\u52A8\u89E6\u53D1" aria-hidden="true">#</a></h3><p>\u4F7F\u7528<code>Jenkins/Gitlab runner</code> \u7B49\u4ED3\u5E93\u76D1\u63A7\u5DE5\u5177\u53BB\u8BBE\u7F6E\u89E6\u53D1\u6761\u4EF6, \u89E6\u53D1\u540E\u6267\u884C\u5F00\u53D1\u81EA\u5DF1\u8BBE\u7F6E\u7684\u76F8\u5E94\u811A\u672C, \u5982\u4E0B\u9762\u662F\u6211\u4E4B\u524D\u8BBE\u7F6E\u7684\u4E00\u4E2Agitlab\u811A\u672C, \u8BE5\u811A\u672C\u53EA\u5BF9 <code>feature/zk</code> \u5206\u652F\u751F\u6548, \u5373\u5982\u679C\u8BE5\u5206\u652F\u6709\u5408\u5165\u6216\u8005\u63A8\u9001\u5C31\u4F1A\u89E6\u53D1\u4E0B\u9762\u7684\u547D\u4EE4, \u66FF\u6362Nginx\u7684\u9759\u6001\u8D44\u6E90</p><blockquote><p>\u540E\u9762\u4F1A\u8865\u5145gitlab runner\u7684\u76F8\u5173\u90E8\u7F72\u7ECF\u5386</p></blockquote><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">image: node:14.7.0</span></span>
<span class="line"><span style="color:#A6ACCD;">cache:</span></span>
<span class="line"><span style="color:#A6ACCD;">  key: \${CI_BUILD_REF_NAME}</span></span>
<span class="line"><span style="color:#A6ACCD;">  paths:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - node_modules/  #\u7F13\u5B58node_modules</span></span>
<span class="line"><span style="color:#A6ACCD;">stages:</span></span>
<span class="line"><span style="color:#A6ACCD;">  #- test</span></span>
<span class="line"><span style="color:#A6ACCD;">  - deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">MES-deploy:</span></span>
<span class="line"><span style="color:#A6ACCD;">  stage: deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">  script:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - echo &#39;***************************&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    - cd ./product</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm install --registry=https://registry.npm.taobao.org</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm run build</span></span>
<span class="line"><span style="color:#A6ACCD;">    - rm -rf /usr/local/nginx/html/dist/product</span></span>
<span class="line"><span style="color:#A6ACCD;">    - cp -r /home/gitlab-runner/builds/hh4QSqNh/0/cdp/cdp-web/dist/product/ /usr/local/nginx/html/dist/product/</span></span>
<span class="line"><span style="color:#A6ACCD;">    - echo &#39;deploy success&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    - cd ..</span></span>
<span class="line"><span style="color:#A6ACCD;">    - echo &#39;***************************&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    - cd ./productGroup</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm install --registry=https://registry.npm.taobao.org</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm run build</span></span>
<span class="line"><span style="color:#A6ACCD;">    - ls</span></span>
<span class="line"><span style="color:#A6ACCD;">    - rm -rf /usr/local/nginx/html/dist/productGroup</span></span>
<span class="line"><span style="color:#A6ACCD;">    - cp -r /home/gitlab-runner/builds/hh4QSqNh/0/cdp/cdp-web/dist/productGroup/ /usr/local/nginx/html/dist/productGroup/</span></span>
<span class="line"><span style="color:#A6ACCD;">    - echo &#39;deploy success&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    - echo &#39;***************************&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">  tags:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - v1</span></span>
<span class="line"><span style="color:#A6ACCD;">  only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - feature/zk</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_1-2-\u624B\u52A8\u89E6\u53D1" tabindex="-1">1.2 \u624B\u52A8\u89E6\u53D1 <a class="header-anchor" href="#_1-2-\u624B\u52A8\u89E6\u53D1" aria-hidden="true">#</a></h3><p>\u8FD9\u79CD\u65B9\u5F0F\u6709\u70B9\u539F\u59CB</p><ol><li>\u4E00\u4E2A\u662F\u81EA\u5DF1\u767B\u9646\u670D\u52A1\u5668\u7136\u540E\u8FD0\u884C\u91CC\u9762\u7684\u6784\u5EFA\u811A\u672C</li><li>\u5F00\u53D1\u5728\u81EA\u5DF1\u7535\u8111\u4E0A\u4F7F\u7528\u811A\u672C\u53BB\u76F4\u8FDE\u670D\u52A1\u5668, \u7136\u540E\u8DD1\u4E00\u4E9B\u811A\u672C</li></ol><p>\u5BF9\u4E8E\u65B9\u5F0F1, \u5C31\u4E0D\u8BF4\u4E86. \u5982\u679C\u662F\u4F7F\u7528\u65B9\u5F0F2, \u90A3\u4E48\u9700\u8981\u76F4\u8FDE\u670D\u52A1\u5668, \u89E3\u51B3\u65B9\u6848\u5728\u4E0B\u9762</p><blockquote><p>\u670D\u52A1\u5668A\u8FDE\u63A5\u670D\u52A1\u5668B, \u5E76\u8FD0\u884C\u670D\u52A1\u5668B\u4E2D\u7684shell\u547D\u4EE4(\u4E0D\u7528\u8F93\u5165\u5BC6\u7801) \u5C06\u670D\u52A1\u5668A\u7684 id_rsa.pub \u590D\u5236\u5230B\u670D\u52A1\u5668\u7684 .ssh/authorized_keys \u4E2D, \u5982\u679CB\u4E2D\u6CA1\u6709\u8BE5\u6587\u4EF6, \u521B\u5EFA\u4E00\u4E2A\u5C31\u53EF\u4EE5 \u5982 ssh root@10.253.xx.xx &quot;pwd&quot; , \u5373\u53EF \u6216\u8005\u4E5F\u53EF\u4EE5\u4F7F\u7528\u4E0B\u9762\u7684\u547D\u4EE4 <code>scp -r id_rsa.pub root@10.253.xx.xx:/root/.ssh/authorized_keys</code> \u6BD4\u5982, \u53EF\u4EE5\u50CF\u4E0B\u9762\u8FD9\u6837\u53BB\u914D\u7F6E</p></blockquote><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">ssh root@10.253.xx.xx &quot;pwd&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">cd /xxx/project/</span></span>
<span class="line"><span style="color:#A6ACCD;">npm run build</span></span>
<span class="line"><span style="color:#A6ACCD;">cp dist /usr/share/nginx/html</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="\u4E8C-\u90E8\u7F72\u65B9\u5F0F" tabindex="-1">\u4E8C. \u90E8\u7F72\u65B9\u5F0F <a class="header-anchor" href="#\u4E8C-\u90E8\u7F72\u65B9\u5F0F" aria-hidden="true">#</a></h2><p>\u8FD9\u91CC\u6709\u4E24\u79CD\u90E8\u7F72\u65B9\u5F0F</p><h3 id="_2-1-\u4F7F\u7528docker\u90E8\u7F72" tabindex="-1">2.1 \u4F7F\u7528Docker\u90E8\u7F72 <a class="header-anchor" href="#_2-1-\u4F7F\u7528docker\u90E8\u7F72" aria-hidden="true">#</a></h3><p>\u5148\u63D0\u4F9B\u76F8\u5173\u6587\u4EF6(Dockerfile: \u955C\u50CF\u6253\u5305, \u8FD9\u91CC\u4F7F\u7528\u4E86\u591A\u9636\u6BB5\u955C\u50CF\u6253\u5305, \u5373\u57FA\u4E8Enode\u751F\u6210\u7684\u6587\u4EF6\u6253\u5305\u751F\u6210nginx\u955C\u50CF)</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">FROM node:16.13-alpine as node</span></span>
<span class="line"><span style="color:#A6ACCD;"># Install app dependencies</span></span>
<span class="line"><span style="color:#A6ACCD;"># A wildcard is used to ensure both package.json AND package-lock.json are copied</span></span>
<span class="line"><span style="color:#A6ACCD;"># where available (npm@5+)</span></span>
<span class="line"><span style="color:#A6ACCD;">COPY . .</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u5B89\u88C5\u4F9D\u8D56</span></span>
<span class="line"><span style="color:#A6ACCD;">RUN yarn install</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u6253\u5305</span></span>
<span class="line"><span style="color:#A6ACCD;">RUN yarn build</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">FROM nginx:latest</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u5C06\u4E0A\u4E00\u6B65\u6253\u5305\u540E\u7684\u6587\u4EF6copy\u5230nginx\u91CC\u9762</span></span>
<span class="line"><span style="color:#A6ACCD;">COPY --from=node dist /usr/share/nginx/html</span></span>
<span class="line"><span style="color:#A6ACCD;">EXPOSE 80</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>\u955C\u50CF\u53EF\u4EE5\u9009\u62E9\u5728\u670D\u52A1\u5668\u4E0A\u6253\u5305, \u7136\u540E\u76F4\u63A5\u91CD\u542F\u6216\u8005\u5728\u672C\u5730\u6216\u8005\u53E6\u4E00\u53F0\u670D\u52A1\u5668\u4E0A\u6253\u5305, \u518D\u4E0A\u4F20\u90E8\u7F72</p><ul><li>\u670D\u52A1\u5668\u4E0A\u6253\u5305</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">// example: \u4E4B\u524D\u8FD0\u884C\u7684\u5BB9\u5668\u662Fweb</span></span>
<span class="line"><span style="color:#A6ACCD;">// \u57FA\u4E8EDockerfile\u6253\u5305\u955C\u50CF</span></span>
<span class="line"><span style="color:#A6ACCD;">docker build -t web-img .</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u7531\u4E8E\u7ECF\u5E38\u91CD\u590D\u6253\u5305, \u6240\u4EE5\u4F7F\u7528\u4E0B\u9762\u7684\u547D\u4EE4\u5220\u9664\u65E0\u7528\u7684\u955C\u50CF</span></span>
<span class="line"><span style="color:#A6ACCD;">docker rmi $(docker images -f &quot;dangling=true&quot; -q)</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">docker rm -f web</span></span>
<span class="line"><span style="color:#A6ACCD;">// \u5C06nginx\u7684\u914D\u7F6E\u6587\u4EF6\u6302\u8F7D\u51FA\u6765</span></span>
<span class="line"><span style="color:#A6ACCD;">docker run -d -it -p 80:80 -v /root/nginx/conf:/etc/nginx/conf.d --name web web-img /bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>\u672C\u5730\u5176\u4ED6\u670D\u52A1\u5668\u6253\u5305\u955C\u50CF</li></ul><p>\u8FD9\u79CD\u60C5\u51B5\u9700\u8981\u628A\u6253\u5305\u7684\u955C\u50CF\u4E0A\u4F20\u5230\u79C1\u5E93, \u7136\u540E\u90E8\u7F72\u670D\u52A1\u5668\u518D\u53BB\u62C9\u53D6\u6700\u65B0\u955C\u50CF\u91CD\u65B0\u90E8\u7F72. \u542C\u8D77\u6765\u53C8\u8981\u4E0A\u4F20\u53C8\u8981\u53BB\u91CD\u65B0\u62C9\u53D6\u5F88\u9EBB\u70E6, \u4F46\u662F\u8FD9\u91CC\u53EF\u4EE5\u4F7F\u7528\u4E00\u4E2A\u955C\u50CF <code>watchtower</code> \u53BB\u5E2E\u52A9\u6211\u4EEC\u81EA\u52A8\u68C0\u6D4B\u955C\u50CF\u662F\u5426\u53D8\u5316, \u662F\u5426\u9700\u8981\u91CD\u65B0\u90E8\u7F72, \u5177\u4F53\u5982\u4E0BDokcerfile\u6587\u4EF6\u7C7B\u4F3C, \u4E3B\u8981\u662F\u6253\u5305\u4E0A\u4F20\u811A\u672C</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">#!/bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u672C\u5730build\u955C\u50CF(\u6307\u5B9Adockerfile\u6587\u4EF6)</span></span>
<span class="line"><span style="color:#A6ACCD;">docker build -t vite . --no-cache</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u672C\u5730\u6253tag</span></span>
<span class="line"><span style="color:#A6ACCD;">docker tag vite 10.253.xx.xx:5000/vite:latest</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u5220\u9664\u65E0\u7528\u7684\u955C\u50CF</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u7531\u4E8E\u7ECF\u5E38\u91CD\u590D\u6253\u5305, \u6240\u4EE5\u4F7F\u7528\u4E0B\u9762\u7684\u547D\u4EE4\u5220\u9664\u65E0\u7528\u7684\u955C\u50CF</span></span>
<span class="line"><span style="color:#A6ACCD;">docker rmi $(docker images -f &quot;dangling=true&quot; -q)</span></span>
<span class="line"><span style="color:#A6ACCD;"># \u63A8\u9001\u5230\u79C1\u6709\u4ED3\u5E93, \u79C1\u6709\u4ED3\u5E93</span></span>
<span class="line"><span style="color:#A6ACCD;">docker push 10.253.xx.xx:5000/vite:latest</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-2-\u666E\u901A\u90E8\u7F72" tabindex="-1">2.2 \u666E\u901A\u90E8\u7F72 <a class="header-anchor" href="#_2-2-\u666E\u901A\u90E8\u7F72" aria-hidden="true">#</a></h3><p>\u666E\u901A\u90E8\u7F72\u6CA1\u4EC0\u4E48\u597D\u8BF4\u7684, \u6253\u5305\u597D\u540E\u66FF\u6362nginx html\u91CC\u9762\u7684\u9759\u6001\u8D44\u6E90\u5373\u53EF, \u4F7F\u7528\u4E00\u4E9B\u7B80\u5355\u7684cp, rm\u547D\u4EE4</p><h2 id="\u4E09-\u8865\u5145" tabindex="-1">\u4E09. \u8865\u5145 <a class="header-anchor" href="#\u4E09-\u8865\u5145" aria-hidden="true">#</a></h2><h3 id="_3-1-gitlab-runner" tabindex="-1">3.1 Gitlab runner <a class="header-anchor" href="#_3-1-gitlab-runner" aria-hidden="true">#</a></h3><p>\u76F8\u5173\u914D\u7F6E\u53EF\u4EE5\u76F4\u63A5\u641C\u7D22gitlab\u5B98\u7F51, \u4E0B\u9762\u662F\u4E00\u4E9B\u4E4B\u524D\u914D\u7F6E\u666E\u901A\u7248\u8E29\u8FC7\u7684\u5751, Docker\u7248\u7684\u540E\u9762\u6211\u518D\u8865\u5145</p><ul><li><p>\u65B0\u5EFA\u4E00\u4E2Agitlab runner\u7528\u6237, \u8FD9\u91CC\u6700\u597D\u6700\u597D\u65B0\u5EFA\u4E3Aroot, \u5426\u5219\u540E\u9762\u4F1A\u6709\u5F88\u591A\u9EBB\u70E6\u7684\u6743\u9650\u95EE\u9898, \u5BFC\u81F4CI/CD\u4E0D\u80FD\u62C9\u53BB\u4EE3\u7801</p><p><code>gitlab-runner install --working-directory /home/gitlab-runner --user root</code></p></li><li><p>\u8BC1\u4E66\u95EE\u9898</p><p>\u7531\u4E8E\u4E00\u4E9Bgitlab\u4F7F\u7528https\u8BC1\u4E66, \u5BFC\u81F4\u6211\u4EEC\u6CE8\u518Cgtilab\u7684\u65F6\u5019\u4F1A\u5728\u4E2D\u95F4\u62A5\u9519<code>X 509...</code> \u8FD9\u79CD</p></li></ul><p>\u89E3\u51B3\u65B9\u6848\u5C31\u662F\u5C06gitlab\u7684\u8BC1\u4E66\u6CE8\u518C\u5230\u670D\u52A1\u5668\u4E0A, \u8BC1\u4E66\u653E\u5728 <code>/etc/pki/ca-trust/source/anchors/</code> \u6587\u4EF6\u5939\u91CC\u9762, \u7136\u540E\u66F4\u65B0\u8BC1\u4E66</p><p>\u6216\u8005\u5728\u6CE8\u518Cgitlab runner\u7684\u65F6\u5019\u4F7F\u7528</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">xxx register --tls-ca-file xxxx  </span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u6307\u5B9A\u8BC1\u4E66</p><ul><li><p>gitlab runner\u62C9\u53D6\u4EE3\u7801\u62A5\u9519</p><p>\u539F\u56E0\u662Fgitlab runner\u8FDE\u63A5\u7684\u65F6\u5019\u4E5F\u9700\u8981\u6709\u81EA\u5DF1\u7684ssh\u5BC6\u94A5 \u5B83\u8D70\u7684\u4E0D\u662F\u670D\u52A1\u5668\u7684ssh key</p></li></ul><p>\u6211\u4EEC\u9700\u8981\u5148\u5728/home/gitlab-runner\u76EE\u5F55\u4E0B\u751F\u6210gitlab runner\u81EA\u5DF1\u7684ssh-key, \u7136\u540E\u5C06\u8FD9\u4E2Akey\u590D\u5236\u5230\u76EE\u5F55\u670D\u52A1\u5668\u7684 <code>/root/.ssh/authorized_keys</code> \u6587\u4EF6\u4E2D, \u540C\u65F6, \u6211\u4EEC\u8FD8\u9700\u8981\u5728gitlab-runner\u670D\u52A1\u5668\u4E0A\u4F7F\u7528gitlab-runner\u7528\u6237\u53BBssh\u8FDE\u63A5\u4E0B, \u8F93\u5165\u786E\u8BA4, \u7136\u540ECI\u624D\u80FD\u6B63\u5E38\u8BBF\u95EE, \u5982\u4E0B\u6240\u793A:</p><p><img src="https://cdn.jsdelivr.net/gh/scattter/blogweb/images/image2.png" alt="image2"></p><p>\u6216\u8005\u53EF\u4EE5\u5C1D\u8BD5\u5728runner\u7684\u914D\u7F6E\u4E2D\u6DFB\u52A0\u4E0B\u9762\u7684</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">environment = [&quot;GIT_SSL_NO_VERIFY=true&quot;]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>\u914D\u7F6E\u5B8C\u7C7B\u4F3C\u4E8E\u4E0B\u9762\u8FD9\u6837</p><p><img src="https://cdn.jsdelivr.net/gh/scattter/blogweb/images/image1.png" alt="image1"></p><h3 id="_3-2-\u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548Cwatchtower\u8FD0\u884C\u7684\u547D\u4EE4" tabindex="-1">3.2 \u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548C<code>watchtower</code>\u8FD0\u884C\u7684\u547D\u4EE4 <a class="header-anchor" href="#_3-2-\u79C1\u6709\u4ED3\u5E93\u521B\u5EFA\u548Cwatchtower\u8FD0\u884C\u7684\u547D\u4EE4" aria-hidden="true">#</a></h3><ul><li>\u79C1\u6709\u4ED3\u5E93</li></ul><p>\u79C1\u6709\u4ED3\u5E93\u76F8\u5173\u77E5\u8BC6\u94FE\u63A5: <a href="https://yeasy.gitbook.io/docker_practice/repository/registry" target="_blank" rel="noreferrer">https://yeasy</a> <a href="https://yeasy.gitbook.io/docker_practice/repository/registry" target="_blank" rel="noreferrer">.gitbook.io/docker_practice/repository/registry</a></p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;"># \u642D\u5EFA\u79C1\u6709\u4ED3\u5E93 </span></span>
<span class="line"><span style="color:#A6ACCD;">$ docker run -d -p 5000:5000 --restart=always --name registry registry</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u672C\u5730/\u670D\u52A1\u5668\u60F3\u8981\u5C06\u955C\u50CF\u63A8\u9001\u5230\u79C1\u6709\u4ED3\u5E93, \u6709\u65F6\u8FD8\u9700\u8981\u5728\u672C\u5730\u914D\u7F6E\u79C1\u6709\u4ED3\u5E93\u7684\u5730\u5740, \u5426\u5219docker\u4E0D\u5141\u8BB8\u4F60\u901A\u8FC7\u975EHTTPS\u7684\u65B9\u5F0F\u63A8\u9001, \u5982\u4E0B</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">registry-mirror</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://hub-mirror.c.163.com</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://mirror.baidubce.com</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">insecure-registries</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">10.253.xx.xx:5000</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>watchtower</li></ul><p>watchtower\u76F8\u5173\u4E2D\u6587\u7F51\u7AD9\u94FE\u63A5: <a href="https://p3terx.com/archives/docker-watchtower.html" target="_blank" rel="noreferrer">https://p3terx.com/archives/docker-watchtower.html</a></p><p><code>watchtower </code> \u652F\u6301\u81EA\u5B9A\u4E49\u76D1\u6D4B\u5BB9\u5668\u5BF9\u8C61, \u4F46\u662F\u6709\u4E00\u70B9, \u5176\u76EE\u524D\u53EA\u652F\u6301\u5B9A\u65F6\u76D1\u6D4B\u5BB9\u5668\u53D8\u5316, \u4E0D\u80FD\u50CFJenkins\u8FD9\u79CD\u5B9E\u65F6\u89E6\u53D1</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">docker run -d \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    --name watchtower \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    --restart unless-stopped \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    -v /var/run/docker.sock:/var/run/docker.sock \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    containrrr/watchtower -c \\</span></span>
<span class="line"><span style="color:#A6ACCD;">    &lt;\u5BB9\u5668\u540D\u5B57&gt; --interval 3600</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;"># \u6216\u8005</span></span>
<span class="line"><span style="color:#A6ACCD;"> docker run -d --name watchtower --restart unless-stopped</span></span>
<span class="line"><span style="color:#A6ACCD;"> -v /var/run/docker.sock:/var/run/docker.sock </span></span>
<span class="line"><span style="color:#A6ACCD;"> containrrr/watchtower -c </span></span>
<span class="line"><span style="color:#A6ACCD;">$(cat ~/zk/.watchtower.list) </span></span>
<span class="line"><span style="color:#A6ACCD;">--interval 3600</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3-3-docker\u90E8\u7F72" tabindex="-1">3.3 Docker\u90E8\u7F72 <a class="header-anchor" href="#_3-3-docker\u90E8\u7F72" aria-hidden="true">#</a></h3><p>Nginx\u7684\u5BB9\u5668\u90E8\u7F72\u547D\u4EE4\u4E00\u822C\u4E3A</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;"># \u540E\u53F0 \u4EA4\u4E92 \u66B4\u6F0F\u7AEF\u53E3 \u6302\u8F7D\u76EE\u5F55 \u540D\u5B57 \u955C\u50CF\u540D \u4EA4\u4E92shell</span></span>
<span class="line"><span style="color:#A6ACCD;">docker run -d -it -p 80:80 -v /root/nginx/conf:/etc/nginx/conf.d --name nginx /bin/bash</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>\u4E0A\u9762\u8FD9\u79CD\u6302\u8F7D\u5982\u679Cconf\u91CC\u9762\u6CA1\u6709\u6587\u4EF6, \u90A3\u4E48\u4E5F\u4F1A\u628Anginx\u955C\u50CF\u91CC\u9762\u76F8\u5BF9\u6587\u4EF6\u5939\u91CC\u9762\u672C\u6765\u5B58\u5728\u7684\u6587\u4EF6\u7ED9\u51B2\u6389.</p><p>\u8FD9\u91CC\u53EF\u4EE5\u4F7F\u7528\u5355\u4E2A\u5BB9\u5668\u90E8\u7F72, \u4E5F\u53EF\u4EE5\u4F7F\u7528docker-compose\u53BB\u90E8\u7F72, compose\u662F\u914D\u7F6E\u578B\u7684\u6587\u4EF6, \u6240\u4EE5\u4F1A\u7B80\u5355\u4E00\u4E9B</p><h2 id="\u56DB-\u63A8\u8350\u65B9\u6848" tabindex="-1">\u56DB. \u63A8\u8350\u65B9\u6848 <a class="header-anchor" href="#\u56DB-\u63A8\u8350\u65B9\u6848" aria-hidden="true">#</a></h2><blockquote><p>\u7B80\u5355\u7684\u624D\u662F\u6700\u597D\u7528\u7684!\u6B64\u5904\u7684\u793A\u4F8B\u662F\u57FA\u4E8E\u81EA\u642D\u5EFA\u7684gitlab\u4ED3\u5E93\u5B9E\u73B0\u7684\uFF0C\u793A\u4F8B\u57FA\u4E8E\u4E0B\u9762\u7684\u6587\u7AE0\u8C03\u8BD5\u5B8C\u6210</p><p><a href="https://juejin.cn/post/6967972435064782879" target="_blank" rel="noreferrer">https://juejin.cn/post/6967972435064782879</a></p><p><a href="https://juejin.cn/post/7074780794459258917#heading-9" target="_blank" rel="noreferrer">https://juejin.cn/post/7074780794459258917#heading-9</a></p></blockquote><p>Gitlab runner(Docker) + Nginx(Docker)\u90E8\u7F72\u4ED3\u5E93\u5730\u5740: <a href="http://124.221.123.79:8084/" target="_blank" rel="noreferrer">http://124.221.123.79:8084/</a></p><h3 id="_4-1-\u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93" tabindex="-1">4.1 \u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93 <a class="header-anchor" href="#_4-1-\u642D\u5EFA\u81EA\u5DF1\u7684gitlab\u4ED3\u5E93" aria-hidden="true">#</a></h3><p>\u56E0\u4E3A\u4ED3\u5E93\u642D\u5EFA\u8D77\u6765\u5F88\u5360\u5185\u5B58\uFF0C\u6240\u4EE5\u6B64\u5904\u670D\u52A1\u5668\u6700\u597D\u662F4G\u5185\u5B58+</p><p>\u6B64\u5904\u642D\u5EFA\u4F7F\u7528docker\u4E2D\u6587\u7248, docker compose\u8FD0\u884C</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">version: &#39;3&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">services:</span></span>
<span class="line"><span style="color:#A6ACCD;">   web:</span></span>
<span class="line"><span style="color:#A6ACCD;">     image: &#39;twang2218/gitlab-ce-zh&#39;   #gitlab\u955C\u50CF</span></span>
<span class="line"><span style="color:#A6ACCD;">     restart: always</span></span>
<span class="line"><span style="color:#A6ACCD;">     privileged: true  #\u6743\u9650</span></span>
<span class="line"><span style="color:#A6ACCD;">     hostname: &#39;&#39;       #\u4E3B\u673A\u540D, \u5373\u865A\u62DF\u673A\u7684IP, \u8FD9\u91CC\u53EF\u4EE5\u662F\u7EAFIP</span></span>
<span class="line"><span style="color:#A6ACCD;">     environment:</span></span>
<span class="line"><span style="color:#A6ACCD;">        TZ: &#39;Asia/Shanghai&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        GITLAB_OMNIBUS_CONFIG: |</span></span>
<span class="line"><span style="color:#A6ACCD;">            external_url &#39;&#39; #\u4E3B\u673A\u540D,\u5373\u865A\u62DF\u673A\u7684IP, \u8FD9\u91CC\u9700\u8981\u6DFB\u52A0http\u524D\u7F00</span></span>
<span class="line"><span style="color:#A6ACCD;">            gitlab_rails[&#39;gitlab_shell_ssh_port&#39;] = 2222</span></span>
<span class="line"><span style="color:#A6ACCD;">            nginx[&#39;listen_port&#39;] = 8084</span></span>
<span class="line"><span style="color:#A6ACCD;">     ports:</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;8084:8084&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;8443:443&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;2222:22&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">     volumes:</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;./config:/etc/gitlab&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;./logs:/var/log/gitlab&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">        - &#39;./data:/var/opt/gitlab&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>\u914D\u7F6E\u89E3\u6790</p><ul><li>external_url: \u8BE5\u53C2\u6570\u662F\u6307\u5B9A\u5916\u90E8\u8BBF\u95EE\u4ED3\u5E93\u7684\u5730\u5740</li><li>gitlab_shell_ssh_port: ssh\u62C9\u53D6\u4EE3\u7801\u7684\u7AEF\u53E3</li><li>nginx[&#39;listen_port&#39;]: nginx\u76D1\u542C\u7AEF\u53E3, \u4E0D\u8BBE\u7F6E\u7684\u8BDD\u5C31\u662Fexternal_url: 80\u6216\u8005443</li></ul><p>\u66F4\u591A\u955C\u50CF\u914D\u7F6E\u53EF\u4EE5\u53C2\u8003: <a href="https://docs.gitlab.com/ee/administration/environment_variables.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee/administration/environment_variables.html</a></p><h3 id="_4-2-\u914D\u7F6Egitlab-runner" tabindex="-1">4.2 \u914D\u7F6EGitlab runner <a class="header-anchor" href="#_4-2-\u914D\u7F6Egitlab-runner" aria-hidden="true">#</a></h3><ul><li>\u542F\u52A8\u5BB9\u5668</li></ul><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">docker run -d --name gitlab-runner --restart always</span></span>
<span class="line"><span style="color:#A6ACCD;">-v /home/gitlab-runner/config:/etc/gitlab-runner </span></span>
<span class="line"><span style="color:#A6ACCD;">-v /var/run/docker.sock:/var/run/docker.sock </span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab/gitlab-runner:latest</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>\u6620\u5C04<code>/var/run/docker.sock</code>\u8FD9\u4E2A\u6587\u4EF6\u662F\u4E3A\u4E86\u8BA9\u5BB9\u5668\u53EF\u4EE5\u901A\u8FC7<code>/var/run/docker.sock</code>\u4E0E<code>Docker</code>\u5B88\u62A4\u8FDB\u7A0B\u901A\u4FE1\uFF0C\u7BA1\u7406\u5176\u4ED6<code>Docker</code>\u5BB9\u5668 <code>-v /home/gitlab-runner/config:/etc/gitlab-runner</code>\u662F\u5C06runner\u7684\u914D\u7F6E\u6587\u4EF6\u6620\u5C04\u5230\u5BBF\u4E3B\u673A<code>/home/gitlab-runner/config</code>\u65B9\u4FBF\u8C03\u6574\u548C\u67E5\u770B\u914D\u7F6E</p><ul><li>\u6CE8\u518Crunner</li></ul><p>\u53EF\u4EE5\u8FDB\u5165\u5BB9\u5668\u8FDB\u884C\u6CE8\u518C, \u4E5F\u53EF\u4EE5\u5728\u5916\u9762\u8FDB\u884C\u6CE8\u518C, \u8FD9\u91CC\u53EF\u4EE5\u4F7F\u7528 <code>gtilab-runner register</code> \u8FDB\u884C\u4EA4\u4E92\u5F0F\u6CE8\u518C, \u6309\u7167\u4E0A\u9762\u63D0\u793A\u586B\u5199\u4FE1\u606F(\u4FE1\u606F\u53EF\u4EE5\u5728\u4E0B\u56FE\u6240\u793A\u4F4D\u7F6E\u627E\u5230)\u5373\u53EF</p><p><img src="https://cdn.jsdelivr.net/gh/scattter/blogweb/images/image.png" alt="image"></p><p>\u5176\u4E2Dexector\u53EF\u4EE5\u9009docker. \u6CE8\u518C\u5B8C\u6BD5\u540E\u6211\u4EEC\u53EF\u4EE5\u5728\u5BBF\u4E3B\u673A\u7684<code>/home/gitlab-runner/config</code> \u6587\u4EF6\u5939\u91CC\u9762\u770B\u89C1runner\u7684\u914D\u7F6E\u4FE1\u606F, \u5982\u4E0B\u6240\u793A</p><p><img src="https://cdn.jsdelivr.net/gh/scattter/blogweb/images/image3.png" alt="image3"></p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">concurrent = 1</span></span>
<span class="line"><span style="color:#A6ACCD;">check_interval = 0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">[session_server]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 session_timeout = 1800</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">[[runners]]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 name = &quot;first-register-runner&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 url = &quot;http://xxx:8084/&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 token = &quot;xxx&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 executor = &quot;docker&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 clone_url = &quot;http://xxx:8084/&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 [runners.custom_build_dir]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 [runners.cache]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 [runners.cache.s3]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 [runners.cache.gcs]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 [runners.cache.azure]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 [runners.docker]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 tls_verify = false</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 image = &quot;alpine:latest&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 privileged = false</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 disable_entrypoint_overwrite = false</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 oom_kill_disable = false</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 disable_cache = false</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 volumes = [&quot;/cache&quot;,&quot;/usr/bin/docker:/usr/bin/docker&quot;,&quot;/var/run/docker.sock:/var/run/docker.sock&quot;]</span></span>
<span class="line"><span style="color:#A6ACCD;">\xA0 \xA0 shm_size = 0</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>\u540E\u7EED\u6709\u4FEE\u6539\u4E5F\u53EF\u4EE5\u76F4\u63A5\u5728\u8FD9\u91CC\u8FDB\u884C\u4FEE\u6539, \u5927\u90E8\u5206\u914D\u7F6E\u4FEE\u6539\u4E0D\u7528\u624B\u52A8\u91CD\u542Frunner \u5BB9\u5668</p><p><strong>\u6CE8\u610F:</strong></p><ul><li>\u7531\u4E8E\u4E0A\u9762\u6211\u4EEC\u914D\u7F6E\u4E86nginx\u76D1\u542C\u7AEF\u53E3, \u800Crunner\u6267\u884C\u7684\u65F6\u5019\u9ED8\u8BA4\u662F\u4ECE80\u7B49\u9ED8\u8BA4\u7AEF\u53E3\u83B7\u53D6\u4ED3\u5E93\u6587\u4EF6\u7684, \u6240\u4EE5\u6211\u4EEC\u8981\u5728\u4E0A\u9762runner\u914D\u7F6Econfig.toml\u4E2D\u589E\u52A0\u4E00\u4E2A\u5C5E\u6027: <code>clone_url</code>, \u5176\u503C\u5C31\u662F\u4E3B\u673A\u5730\u5740\u548Cnginx\u76D1\u542C\u7684\u7AEF\u53E3</li><li>volumes\u91CC\u9762\u6DFB\u52A0docker\u7684\u4E00\u4E9B\u914D\u7F6E, \u8FD9\u6837\u5C31\u53EF\u4EE5\u5728runner\u7684docker\u91CC\u9762\u521B\u5EFA\u57FA\u4E8E\u5BBF\u4E3B\u673A\u7684\u65B0docker(nginx)</li></ul><h3 id="_4-3-\u521B\u5EFA-gitlab-ci-yml\u6587\u4EF6" tabindex="-1">4.3 \u521B\u5EFA.gitlab-ci.yml\u6587\u4EF6 <a class="header-anchor" href="#_4-3-\u521B\u5EFA-gitlab-ci-yml\u6587\u4EF6" aria-hidden="true">#</a></h3><blockquote><p>\u5982\u679C\u662F\u4F7F\u7528https, \u90A3\u4E48\u9700\u8981\u5BFB\u627E\u81EA\u7B7E\u8BC1\u4E66 <a href="https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates-targeting-the-gitlab-server" target="_blank" rel="noreferrer">https://docs.gitlab.com/runner/configuration/tls-self-signed.html#supported-options-for-self-signed-certificates-targeting-the-gitlab-server</a> \u5176\u4ED6\u7684\u4E00\u4E9Brunner\u914D\u7F6E\u53EF\u4EE5\u53BBgitlab\u4E0A\u641C\u7D22\u4E00\u4E0B, \u6211\u4E4B\u524D\u914D\u7F6E\u516C\u53F8\u7684runner\u5931\u8D25\u4E86, \u627E\u4E0D\u5230\u5B8C\u6574\u8BC1\u4E66 ci\u914D\u7F6E\u6587\u4EF6</p></blockquote><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">image: node:alpine</span></span>
<span class="line"><span style="color:#A6ACCD;">stages: # \u5206\u6BB5</span></span>
<span class="line"><span style="color:#A6ACCD;">  - install</span></span>
<span class="line"><span style="color:#A6ACCD;">  - build</span></span>
<span class="line"><span style="color:#A6ACCD;">  - deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">cache: # \u7F13\u5B58</span></span>
<span class="line"><span style="color:#A6ACCD;">  paths:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - node_modules</span></span>
<span class="line"><span style="color:#A6ACCD;">job_install:</span></span>
<span class="line"><span style="color:#A6ACCD;">  tags:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - v2</span></span>
<span class="line"><span style="color:#A6ACCD;">  stage: install</span></span>
<span class="line"><span style="color:#A6ACCD;">  script:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm install</span></span>
<span class="line"><span style="color:#A6ACCD;">  only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - master</span></span>
<span class="line"><span style="color:#A6ACCD;">job_build:</span></span>
<span class="line"><span style="color:#A6ACCD;">  tags:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - v2</span></span>
<span class="line"><span style="color:#A6ACCD;">  stage: build</span></span>
<span class="line"><span style="color:#A6ACCD;">  script:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - npm run build</span></span>
<span class="line"><span style="color:#A6ACCD;">  artifacts:</span></span>
<span class="line"><span style="color:#A6ACCD;">    paths:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - dist/</span></span>
<span class="line"><span style="color:#A6ACCD;">    expire_in: 3 mins</span></span>
<span class="line"><span style="color:#A6ACCD;">  only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - master</span></span>
<span class="line"><span style="color:#A6ACCD;">job_deploy:</span></span>
<span class="line"><span style="color:#A6ACCD;">  tags:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - v2</span></span>
<span class="line"><span style="color:#A6ACCD;">  image: docker</span></span>
<span class="line"><span style="color:#A6ACCD;">  stage: deploy</span></span>
<span class="line"><span style="color:#A6ACCD;">  dependencies:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - job_build</span></span>
<span class="line"><span style="color:#A6ACCD;">  script:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - docker build . -t app-images</span></span>
<span class="line"><span style="color:#A6ACCD;">    - if [ $(docker ps -aq --filter name=app-container) ]; then docker rm -f app-container;fi</span></span>
<span class="line"><span style="color:#A6ACCD;">    - docker run -d -p 8082:80 --name app-container app-images</span></span>
<span class="line"><span style="color:#A6ACCD;">  only:</span></span>
<span class="line"><span style="color:#A6ACCD;">    - master</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>dockerfile\u914D\u7F6E</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;">FROM nginx:latest</span></span>
<span class="line"><span style="color:#A6ACCD;">COPY  ./dist /usr/share/nginx/html</span></span>
<span class="line"><span style="color:#A6ACCD;">EXPOSE 80</span></span>
<span class="line"><span style="color:#A6ACCD;"># nginx\u7684\u5B98\u65B9\u955C\u50CFDockerfile \u5DF2\u7ECF\u6307\u5B9A nginx -g &quot;daemon off;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">CMD [&quot;/usr/sbin/nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>\u8FD9\u91CC\u5BF9\u539F\u6587\u7684\u914D\u7F6E\u8FDB\u884C\u4E86\u4E00\u4E9B\u6539\u9020, \u53BB\u6389\u4E86\u65E0\u7528\u7684\u4E1C\u897F, \u6700\u540E\u7ED3\u679C\u662F\u914D\u7F6E\u4E86\u4E09\u4E2Ajob, \u5206\u522B\u4E3A\u5B89\u88C5\u4F9D\u8D56\u548C\u6253\u5305, \u6700\u540E\u4F7F\u7528\u6253\u5305job\u751F\u6210\u7684dist\u6587\u4EF6\u5939\u8FDB\u884Cnginx docker\u6784\u5EFA\u4E0E\u90E8\u7F72</p><h2 id="\u4E94-\u6269\u5C55-\u4F7F\u7528github-action" tabindex="-1">\u4E94. \u6269\u5C55 - \u4F7F\u7528Github action <a class="header-anchor" href="#\u4E94-\u6269\u5C55-\u4F7F\u7528github-action" aria-hidden="true">#</a></h2><p>\u4ED3\u5E93\u5730\u5740: <a href="https://github.com/scattter/template-react" target="_blank" rel="noreferrer">https://github.com/scattter/template-react</a></p><p>github\u7ED9\u6BCF\u4E2A\u7528\u6237\u9ED8\u8BA4\u63D0\u4F9B\u4E86\u670D\u52A1\u5668\u6765\u8DD1\u6D41\u6C34\u7EBF, \u6240\u4EE5\u53EA\u9700\u8981\u901A\u8FC7github\u4ED3\u5E93\u7684action\u4ED3\u5E93\u914D\u7F6E\u6D41\u6C34\u7EBF\u5373\u53EF</p><p>\u914D\u7F6E\u6587\u4EF6(\u4E0D\u540C\u9879\u76EE\u53EF\u4EE5\u8BBE\u7F6E\u4E0D\u540C\u7684action)</p><div class="language- line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki"><code><span class="line"><span style="color:#A6ACCD;"># This is a basic workflow to help you get started with Actions</span></span>
<span class="line"><span style="color:#A6ACCD;">name: Auto deploy</span></span>
<span class="line"><span style="color:#A6ACCD;"># Controls when the workflow will run</span></span>
<span class="line"><span style="color:#A6ACCD;">on:</span></span>
<span class="line"><span style="color:#A6ACCD;">  # Triggers the workflow on push or pull request events but only for the main branch</span></span>
<span class="line"><span style="color:#A6ACCD;">  push:</span></span>
<span class="line"><span style="color:#A6ACCD;">    branches: [ main, dev ]</span></span>
<span class="line"><span style="color:#A6ACCD;">  pull_request:</span></span>
<span class="line"><span style="color:#A6ACCD;">    branches: [ main, dev ]</span></span>
<span class="line"><span style="color:#A6ACCD;"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span>
<span class="line"><span style="color:#A6ACCD;">jobs:</span></span>
<span class="line"><span style="color:#A6ACCD;">  # This workflow contains a single job called &quot;build&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  build:</span></span>
<span class="line"><span style="color:#A6ACCD;">    # The type of runner that the job will run on</span></span>
<span class="line"><span style="color:#A6ACCD;">    runs-on: ubuntu-latest</span></span>
<span class="line"><span style="color:#A6ACCD;">    # Steps represent a sequence of tasks that will be executed as part of the job</span></span>
<span class="line"><span style="color:#A6ACCD;">    steps:</span></span>
<span class="line"><span style="color:#A6ACCD;">      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it</span></span>
<span class="line"><span style="color:#A6ACCD;">      - uses: actions/checkout@v3</span></span>
<span class="line"><span style="color:#A6ACCD;">      - name: Setup Node.js environment</span></span>
<span class="line"><span style="color:#A6ACCD;">        uses: actions/setup-node@v3.1.1</span></span>
<span class="line"><span style="color:#A6ACCD;">        with:</span></span>
<span class="line"><span style="color:#A6ACCD;">          node-version: &quot;14.X&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      - name: install deps</span></span>
<span class="line"><span style="color:#A6ACCD;">        run: npm install</span></span>
<span class="line"><span style="color:#A6ACCD;">      - name: build app</span></span>
<span class="line"><span style="color:#A6ACCD;">        run: npm run build</span></span>
<span class="line"><span style="color:#A6ACCD;">      - name: deploy build file with scp</span></span>
<span class="line"><span style="color:#A6ACCD;">        uses: appleboy/scp-action@master</span></span>
<span class="line"><span style="color:#A6ACCD;">        with:</span></span>
<span class="line"><span style="color:#A6ACCD;">          host: \${{ secrets.REMOTE_HOST }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          username: &#39;root&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">          password: \${{ secrets.REMOTE_PASSWORD }}</span></span>
<span class="line"><span style="color:#A6ACCD;">          port: 22</span></span>
<span class="line"><span style="color:#A6ACCD;">          source: &quot;dist/&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">          target: \${{ secrets.REMOTE_WORK_DIR }}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>\u4E0A\u9762\u7684 <code>secrets.REMOTE_HOST</code> \u7B49\u662F\u7528\u6237\u81EA\u5DF1\u914D\u7F6E\u5728github\u4ED3\u5E93\u7684, \u8FD9\u6837\u5C31\u907F\u514D\u4E86\u79C1\u5BC6\u4FE1\u606F\u7684\u6CC4\u9732 \u9AD8\u9636\u7684\u4E00\u4E9Baction\u914D\u7F6E(\u5982docker\u90E8\u7F72)\u6211\u6682\u65F6\u8FD8\u6CA1\u6709\u53BB\u770B</p>`,90),r=[p];function c(o,i,t,b,u,C){return n(),a("div",null,r)}const m=s(e,[["render",c]]);export{d as __pageData,m as default};
