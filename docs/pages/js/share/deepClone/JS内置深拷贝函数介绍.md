# JSå†…ç½®æ·±æ‹·è´å‡½æ•°ä»‹ç»

> å‚è€ƒèµ„æ–™
>
> https://www.builder.io/blog/structured-clone
>
> https://developer.mozilla.org/en-US/docs/Web/API/structuredClone



## èƒŒæ™¯

ä¸€ç›´ä»¥æ¥, æ— è®ºæ˜¯å·¥ä½œè¿˜æ˜¯å‰ç«¯é¢è¯•, å¯¹è±¡çš„æµ…/æ·±æ‹·è´éƒ½æ˜¯å¤§å®¶ä¸å¯é¿å…ä¼šé‡åˆ°çš„ä¸€ä¸ªçŸ¥è¯†ç‚¹. æµ…æ‹·è´è‡ªç„¶å¾ˆç®€å•, ç®€å•çš„èµ‹å€¼å³å¯; è€Œå¯¹äºæ·±æ‹·è´æ¥è¯´, åœ¨æ—¥å¸¸å·¥ä½œä¸­, å¤§å®¶å¯èƒ½ä¼šä½¿ç”¨`loadsh` çš„æ–¹æ³•å»å®ç°å…·ä½“åŠŸèƒ½, é¢è¯•ä¸­å¯èƒ½ä¼šæ‰‹å†™é€’å½’å»å®ç°, è¿™ä¸¤ä¸ªå®ç°æ–¹å¼è™½ç„¶éƒ½å¾ˆæœ‰æ•ˆ, ä½†æ˜¯éƒ½æœ‰äº›ç¹ç, ä¸å¤Ÿç®€æ´. å¹¸è¿çš„æ˜¯åœ¨NODE 17+, æµè§ˆå™¨2022.3 + çš„æ–°ç‰ˆæœ¬ä¸­å†…ç½®äº†ä¸€ä¸ªåŸç”Ÿçš„æ·±æ‹·è´API: `structuredClone` , å¼€å‘è€…å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥APIè¿›è¡Œæ·±æ‹·è´.



## ä¸åŒå®ç°æ–¹å¼çš„æ¯”è¾ƒ

### 1. JSON.parse(JSON.stringify(Obj))

è¿™ç§æ–¹å¼ä¸»è¦æ˜¯

1. é¦–å…ˆä½¿ç”¨ `JSON.stringify()` æ–¹æ³•å°†å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚JSON.stringify() æ–¹æ³•ä¼šå°†å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾å±æ€§åŠå…¶å€¼é€’å½’åœ°è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²(åœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œä¸€äº›éšå¼è½¬æ¢, è¿™ä¹Ÿæ˜¯å…¶ä¸­çš„ä¸€ä¸ªé™·é˜±)ã€‚
2. å°†ä¸Šè¿°è½¬æ¢åçš„å­—ç¬¦ä¸²ä½¿ç”¨`JSON.parse()` æ–¹æ³•å°† JSON å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡ã€‚

å¯¹äºå¤§éƒ¨åˆ†ç®€å•å¯¹è±¡è¿™ç§æ–¹æ³•å¾ˆå¥æ•ˆ, ä½†æ˜¯åˆ«å¿˜äº†ç¬¬ä¸€æ­¥åºåˆ—åŒ–çš„æ—¶å€™ä¼šå¯¹ä¸€äº›ç±»å‹è¿›è¡Œéšå¼è½¬æ¢, æ¯”å¦‚æ—¶é—´æ ¼å¼ä¼šç›´æ¥è½¬æ¢ä¸ºå­—ç¬¦ä¸², å…·ä½“å¦‚ä¸‹:

```javascript
const calendarEvent = {
  title: "calendar",
  date: new Date(123),
  attendees: ["Steve"]
}

const problematicCopy = JSON.parse(JSON.stringify(calendarEvent))
console.log(problematicCopy)
```

æœŸæœ›çš„è¾“å‡ºä¸º

```javascript
{
  title: "calendar",
  date: new Date(123),
  attendees: ["Steve"]
}
```

å®é™…çš„è¾“å‡ºä¸º

```
{
  title: "calendar",
  date: "1970-01-01T00:00:00.123Z"
  attendees: ["Steve"]
}
```

å…¶ä»–è¿˜æœ‰`Set` æ ¼å¼çš„æ•°æ®ä¼šè¢«ç®€å•è½¬æ¢ä¸º`{}` ç­‰, å› æ­¤å…¶æœ‰å¾ˆå¤§å±€é™æ€§.

å…¶æ— æ³•æ·±æ‹·è´çš„ä¸»è¦ç±»å‹å¦‚ä¸‹:

- **æ— æ³•å¤åˆ¶ä¸å¯æšä¸¾å±æ€§**ï¼šJSON.stringify() æ–¹æ³•åªä¼šå°†å¯¹è±¡çš„**å¯æšä¸¾å±æ€§**è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œä½¿ç”¨ JSON.parse(JSON.stringify(Obj)) æ–¹æ³•æ— æ³•å¤åˆ¶å¯¹è±¡çš„ä¸å¯æšä¸¾å±æ€§ã€‚
- **æ— æ³•å¤åˆ¶å‡½æ•°ã€Symbol å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼**ï¼šJSON.stringify() æ–¹æ³•æ— æ³•å°†å‡½æ•°ã€Symbol å€¼å’Œæ­£åˆ™è¡¨è¾¾å¼è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ã€‚å› æ­¤ï¼Œä½¿ç”¨ JSON.parse(JSON.stringify(Obj)) æ–¹æ³•æ— æ³•å¤åˆ¶å¯¹è±¡çš„è¿™äº›å±æ€§ã€‚
- **ä¼šæ”¹å˜æ—¥æœŸå¯¹è±¡çš„æ ¼å¼**ï¼šJSON.stringify() æ–¹æ³•ä¼šå°†æ—¥æœŸå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼ã€‚å› æ­¤ï¼Œä½¿ç”¨ JSON.parse(JSON.stringify(Obj)) æ–¹æ³•ä¼šæ”¹å˜æ—¥æœŸå¯¹è±¡çš„æ ¼å¼ã€‚





### 2. æ‰‹å†™æ·±æ‹·è´

è¿™ç§æ–¹å¼ä¸»è¦æ˜¯å¼€å‘è‡ªå·±æ‰‹å†™ä¸€ä¸ªæ·±æ‹·è´å‡½æ•°, éå†æ·±æ‹·è´å¯¹è±¡çš„å±æ€§, ç„¶åæ ¹æ®ä¸åŒçš„ç±»å‹åšé’ˆå¯¹æ€§çš„å¤„ç†, å…¶ä¼˜ç‚¹æ˜¯:

- æ–¹æ³•çš„å®ç°çµæ´»å…¨é¢, å¯ä»¥è‡ªå·±å†³å®šæ€ä¹ˆè¿›è¡Œæ·±æ‹·è´
- è°ƒç”¨ç®€å•, ä¸ç”¨å…¶ä»–ä¾èµ–

ç¼ºç‚¹æ˜¯:

- è¾¹ç¼˜æƒ…å†µå¯èƒ½è€ƒè™‘ä¸å…¨
- å¢åŠ å·¥ä½œé‡, ä¸”æ¯å½“æœ‰æ–°é¡¹ç›®å¯èƒ½éƒ½éœ€è¦è¿›è¡Œç»´æŠ¤



### 3. _.deepClone

è¿™ç§æ–¹å¼æ˜¯ç›´æ¥è°ƒç”¨`lodash` åº“è¿›è¡Œå¤„ç†, ä¼˜ç‚¹æ˜¯

- `lodash` å®˜æ–¹ä¸ºå¼€å‘è€…è€ƒè™‘äº†å„ç§è¾¹ç¼˜æƒ…å†µ
- `lodash` è¿˜æœ‰å¦ä¸€ä¸ªç±»ä¼¼çš„API `cloneDeepWith` , æ”¯æŒå¼€å‘è€…è‡ªå®šä¹‰æ·±æ‹·è´æ–¹å¼

ç¼ºç‚¹(ç”¨ä¸å®Œç¾æ¥å½¢å®¹å¯èƒ½æ›´å¥½)åˆ™æ˜¯:

- éœ€è¦ä¾èµ–ç¬¬ä¸‰åº“, é¡¹ç›®è¦è¿›è¡Œä¸€äº›tree shakingé˜²æ­¢å¼•å…¥é¢å¤–èµ„æºé€ æˆæ‰“åŒ…ä½“ç§¯è¿‡å¤§



### 4. structuredClone

è¯¥æ–¹æ³•æ˜¯2022å¹´åçš„æ–°API, ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•, ç›´æ¥è°ƒç”¨å³å¯, MDNä¸Šå¯¹å…¶çš„ä»‹ç»ä¸º:

> å…¨å±€çš„ **`structuredClone()`** æ–¹æ³•ä½¿ç”¨[ç»“æ„åŒ–å…‹éš†ç®—æ³•](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)å°†ç»™å®šçš„å€¼è¿›è¡Œ[æ·±æ‹·è´](https://developer.mozilla.org/zh-CN/docs/Glossary/Deep_copy)ã€‚

å…¶åŸºç¡€çš„ä½¿ç”¨å¦‚ä¸‹:

```javascript
const calendarEvent = {
  title: "Builder.io Conf",
  date: new Date(123),
  attendees: ["Steve"]
}

// ğŸ˜
const copied = structuredClone(calendarEvent)

copied.attendees // ["Steve"]
copied.date // Date: Wed Dec 31 1969 16:00:00
cocalendarEvent.attendees === copied.attendees // false
```

é™¤æ­¤ä¹‹å¤–, è¯¥æ–¹æ³•è¿˜æ”¯æŒç¬¬äºŒä¸ªå‚æ•° `structuredClone(value, { transfer })`

ç¬¬äºŒä¸ªå‚æ•°`transfer`æ˜¯ä¸€ä¸ª[å¯è½¬ç§»å¯¹è±¡](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Transferable_objects)çš„æ•°ç»„ï¼Œé‡Œé¢çš„ `å€¼` å¹¶æ²¡æœ‰è¢«å…‹éš†ï¼Œè€Œæ˜¯è¢«è½¬ç§»åˆ°è¢«æ‹·è´å¯¹è±¡ä¸Šã€‚MDNä¸Šçš„è¯´æ˜å¦‚ä¸‹(è¿™é‡Œæ¶‰åŠåˆ°çŸ¥è¯†ç›²åŒºäº†, å°±çœ‹äº†ä¸‹æ²¡ç»§ç»­æ·±ç©¶):

![image-20240303163539788](https://cdn.jsdelivr.net/gh/scattter/blogweb/images/image-20240303163539788.png)

é‚£ä¹ˆè¯¥APIæ˜¯å¦æœ‰ç¼ºç‚¹å‘¢? ç­”æ¡ˆæ˜¯è‚¯å®šçš„

1. ç”±äºè¯¥APIè¾ƒæ–°, æ‰€ä»¥ä¸€äº›æ—§çš„æµè§ˆå™¨(2022.3å‰)å’Œ`NODE 17-` å¯èƒ½ä¸ä¼šæ”¯æŒ, ä¸è¿‡`core-js` æœ‰å¯¹å…¶çš„polyfill
   1. è™½ç„¶è¯¥APIå¯¹äºä¸€äº›ç‰¹æ®Šç±»å‹(å¦‚Date)ä¹Ÿèƒ½å®Œç¾å¤åˆ¶, ä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€äº›ç‰¹æ®Šç±»å‹ä¸èƒ½å®Œç¾æ·±æ‹·è´(å½“ç„¶ `loadsh` ä¹Ÿä¸æ”¯æŒ), å…·ä½“å¦‚ä¸‹
   2. å‡½æ•°
   3. DOM å…ƒç´ 
   4. Symbol å€¼
   5. WeakMap å’Œ WeakSet
   6. å¾ªç¯å¼•ç”¨
   7. åŸå‹é“¾



## æ€»ç»“

å¯ä»¥çœ‹åˆ°ä¸Šé¢å››ç§æ·±æ‹·è´çš„æ–¹å¼å„æœ‰ä¼˜åŠ£, å…·ä½“ä¸º:

|                                   | ä¼˜åŠ¿                                   | åŠ£åŠ¿                                |
| --------------------------------- | -------------------------------------- | ----------------------------------- |
| `JSON.parse(JSON.stringify(Obj))` | ç®€å•æ–¹ä¾¿                               | ä¸æ”¯æŒçš„æ•°æ®ç±»å‹å¤ªå¤š                |
| `æ‰‹å†™æ·±æ‹·è´`                      | å®ç°çµæ´», å¯æ§, æ”¯æŒçš„ç±»å‹å¯ä»¥åšåˆ°æœ€å…¨ | éº»çƒ¦, è¾¹ç¼˜æƒ…å†µå¯èƒ½è€ƒè™‘ä¸å……åˆ†        |
| `_.deepClone`                     | é è°±, çœå¿ƒ, è¾¹ç¼˜æƒ…å†µè€ƒè™‘å……åˆ†           | éœ€è¦è¿›è¡Œæ‰“åŒ…ä¼˜åŒ–                    |
| `structuredClone`                 | è°ƒç”¨ç®€å•æ–¹ä¾¿, æ²¡æœ‰è´Ÿæ‹…                 | APIè¾ƒæ–°, ä¾ç„¶æœ‰ä¸€äº›ä¸æ”¯æŒçš„ç‰¹æ®Šç±»å‹ |

ç»¼ä¸Šæ‰€çœ‹, å·¥ä½œä¸­`_.deepClone`è¿˜æ˜¯å…¶ä¸­æœ€é è°±/çœå¿ƒçš„æ–¹å¼, `structuredClone` æ˜¯ä¸€ç§æ–°çš„API, åœ¨æ·±æ‹·è´éœ€æ±‚ä¸å¤æ‚æ—¶å¯ä»¥å°è¯•ä½¿ç”¨.

